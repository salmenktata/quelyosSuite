#!/bin/bash

# Hook pre-commit : DÃ©tection rÃ©fÃ©rences Odoo dans UI
# Bloque commits avec "Odoo" visible dans frontend/backoffice (hors legal/)

echo "ğŸ” VÃ©rification rÃ©fÃ©rences Odoo dans UI..."

# Fichiers stagÃ©s pour commit
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(frontend/src|backoffice/src)/.*\.(tsx?|jsx?)$' | grep -v 'legal/')

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Recherche violations P0
VIOLATIONS=""
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    # Grep pour "Odoo" dans strings/tooltips (hors commentaires)
    MATCHES=$(grep -n -i 'odoo' "$file" | grep -v '^\s*//' | grep -v 'lib/odoo')
    if [ -n "$MATCHES" ]; then
      VIOLATIONS="$VIOLATIONS\nâŒ $file:\n$MATCHES\n"
    fi
  fi
done

if [ -n "$VIOLATIONS" ]; then
  echo "ğŸš« COMMIT BLOQUÃ‰ - RÃ©fÃ©rences Odoo dÃ©tectÃ©es dans UI:"
  echo -e "$VIOLATIONS"
  echo ""
  echo "ğŸ’¡ Solutions:"
  echo "   1. Utiliser /no-odoo --fix pour corrections automatiques"
  echo "   2. Remplacer manuellement (voir .claude/commands/no-odoo.md)"
  echo ""
  echo "âœ… Exception autorisÃ©e: frontend/src/app/legal/page.tsx (conformitÃ© LGPL)"
  exit 1
fi

echo "âœ… Aucune rÃ©fÃ©rence Odoo dans UI"

# Phase 2 : VÃ©rification champs API (vitrine-client uniquement)
echo "ğŸ” VÃ©rification champs API backend dans vitrine-client..."

VITRINE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'vitrine-client/src/.*\.(tsx?|jsx?)$' | grep -v 'api-anonymizer.ts' | grep -v 'lib/odoo/' | grep -v '\.test\.')

API_VIOLATIONS=""
for file in $VITRINE_FILES; do
  if [ -f "$file" ]; then
    # Grep pour champs Odoo (list_price, default_code, qty_available, attribute_lines)
    API_MATCHES=$(grep -n -E '\blist_price\b|\bdefault_code\b|\bqty_available\b|\battribute_lines\b' "$file" 2>/dev/null)
    if [ -n "$API_MATCHES" ]; then
      API_VIOLATIONS="$API_VIOLATIONS\nâš ï¸  $file:\n$API_MATCHES\n"
    fi
  fi
done

if [ -n "$API_VIOLATIONS" ]; then
  echo "ğŸš« COMMIT BLOQUÃ‰ - Champs API backend dÃ©tectÃ©s dans vitrine-client:"
  echo -e "$API_VIOLATIONS"
  echo ""
  echo "ğŸ’¡ Utiliser les noms standards:"
  echo "   list_price â†’ price"
  echo "   default_code â†’ sku"
  echo "   qty_available â†’ stock_quantity"
  echo "   attribute_lines â†’ attributes"
  echo ""
  echo "ğŸ“„ Voir .claude/commands/no-odoo.md (Phase 2)"
  exit 1
fi

echo "âœ… Champs API anonymisÃ©s"
exit 0
