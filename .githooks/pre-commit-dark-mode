#!/bin/bash

# Hook pre-commit pour v√©rifier le dark mode dans le backoffice
# Ce hook v√©rifie que tous les fichiers modifi√©s respectent les r√®gles du dark mode

# Obtenir la liste des fichiers modifi√©s (staged)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(backoffice/src/(pages|components)/.*\.tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  # Aucun fichier TypeScript React modifi√©
  exit 0
fi

echo "üåì V√©rification du dark mode sur les fichiers modifi√©s..."

ERRORS=0

for FILE in $STAGED_FILES; do
  # V√©rifier uniquement si le fichier existe (pas supprim√©)
  if [ ! -f "$FILE" ]; then
    continue
  fi

  filename=$(basename "$FILE")

  # Ignorer Login.tsx et certains composants sp√©ciaux
  if [[ "$filename" == "Login.tsx" ]] || [[ "$filename" == "DarkModeDebug.tsx" ]]; then
    continue
  fi

  # V√©rifier si le fichier contient bg-white sans dark:bg-
  if grep -q 'className.*bg-white[^-]' "$FILE"; then
    if ! grep -q 'dark:bg-' "$FILE"; then
      echo "‚ùå $FILE - bg-white sans variante dark"
      ERRORS=$((ERRORS + 1))
    fi
  fi

  # V√©rifier si le fichier contient border-gray sans dark:border-
  if grep -q 'className.*border-gray-[0-9]' "$FILE"; then
    if ! grep -q 'dark:border-' "$FILE"; then
      echo "‚ö†Ô∏è  $FILE - Bordures grises sans variante dark (v√©rifier si n√©cessaire)"
    fi
  fi
done

if [ $ERRORS -gt 0 ]; then
  echo ""
  echo "‚ùå $ERRORS erreur(s) de dark mode d√©tect√©e(s)"
  echo ""
  echo "Toutes les classes bg-white doivent avoir une variante dark:bg-gray-*"
  echo "Consultez backoffice/DARK_MODE.md pour les bonnes pratiques"
  echo ""
  echo "Pour ignorer cette v√©rification (non recommand√©) : git commit --no-verify"
  exit 1
fi

echo "‚úÖ Dark mode OK"
exit 0
