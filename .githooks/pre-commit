#!/bin/bash
# Git hook pre-commit pour v√©rifier les modifications de mod√®les Odoo et le dark mode

# Couleurs
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# ================================================
# 1. V√âRIFICATION ODOO MODEL
# ================================================
echo "üîç Checking for Odoo model modifications..."

# V√©rifier si des fichiers de mod√®les ont √©t√© modifi√©s
MODIFIED_MODELS=$(git diff --cached --name-only | grep "odoo-backend/addons/.*/models/.*\.py" || true)

if [ -z "$MODIFIED_MODELS" ]; then
    echo "‚úÖ No model modifications detected"
    exit 0
fi

echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Odoo model files modified:${NC}"
echo "$MODIFIED_MODELS" | sed 's/^/  - /'
echo ""

# V√©rifier si la version du module a √©t√© incr√©ment√©e
MANIFEST_MODIFIED=$(git diff --cached --name-only | grep "odoo-backend/addons/.*/\__manifest__\.py" || true)

if [ -z "$MANIFEST_MODIFIED" ]; then
    echo -e "${RED}‚ùå CRITICAL: Model modified but __manifest__.py NOT updated!${NC}"
    echo ""
    echo "üìù Required actions:"
    echo "  1. Increment module version in odoo-backend/addons/quelyos_api/__manifest__.py"
    echo "  2. Run: cd odoo-backend && ./upgrade.sh quelyos_api"
    echo "  3. Test the API endpoints"
    echo "  4. Re-commit with: git add odoo-backend/addons/quelyos_api/__manifest__.py"
    echo ""
    echo -e "${YELLOW}üí° To bypass this check (NOT recommended): git commit --no-verify${NC}"
    echo ""
    exit 1
fi

# V√©rifier que la version a bien chang√©
VERSION_CHANGED=$(git diff --cached odoo-backend/addons/quelyos_api/__manifest__.py | grep "^\+.*'version'" || true)

if [ -z "$VERSION_CHANGED" ]; then
    echo -e "${RED}‚ùå CRITICAL: __manifest__.py modified but version NOT incremented!${NC}"
    echo ""
    echo "üìù Required action:"
    echo "  - Increment the 'version' field in __manifest__.py"
    echo "    Example: '19.0.1.0.0' ‚Üí '19.0.1.0.1'"
    echo ""
    echo -e "${YELLOW}üí° To bypass this check (NOT recommended): git commit --no-verify${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}‚úÖ __manifest__.py version incremented${NC}"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  REMINDER: After commit, run:${NC}"
echo "  cd odoo-backend && ./upgrade.sh quelyos_api"
echo ""
echo "Press Enter to continue with Odoo checks, or Ctrl+C to cancel"
read

# ================================================
# 2. V√âRIFICATION DARK MODE (Backoffice)
# ================================================
echo ""
echo "üåì Checking dark mode compliance in dashboard-client..."

STAGED_BACKOFFICE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(dashboard-client/src/(pages|components)/.*\.tsx)$' || true)

if [ -z "$STAGED_BACKOFFICE_FILES" ]; then
  echo "‚úÖ No dashboard-client files modified"
  exit 0
fi

DARK_MODE_ERRORS=0

for FILE in $STAGED_BACKOFFICE_FILES; do
  if [ ! -f "$FILE" ]; then
    continue
  fi

  filename=$(basename "$FILE")

  # Ignorer certains fichiers sp√©ciaux
  if [[ "$filename" == "Login.tsx" ]] || [[ "$filename" == "DarkModeDebug.tsx" ]]; then
    continue
  fi

  # V√©rifier bg-white sans dark:bg-
  if grep -q 'className.*bg-white[^-]' "$FILE"; then
    if ! grep -q 'dark:bg-' "$FILE"; then
      echo -e "${RED}‚ùå $FILE - bg-white sans variante dark${NC}"
      DARK_MODE_ERRORS=$((DARK_MODE_ERRORS + 1))
    fi
  fi
done

if [ $DARK_MODE_ERRORS -gt 0 ]; then
  echo ""
  echo -e "${RED}‚ùå $DARK_MODE_ERRORS dark mode error(s) detected${NC}"
  echo ""
  echo "üìù All bg-white classes must have a dark:bg-gray-* variant"
  echo "   See dashboard-client/DARK_MODE.md for best practices"
  echo ""
  echo -e "${YELLOW}üí° To bypass this check (NOT recommended): git commit --no-verify${NC}"
  exit 1
fi

echo -e "${GREEN}‚úÖ Dark mode compliance OK${NC}"
exit 0
