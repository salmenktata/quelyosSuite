name: Validate Configuration URLs

# DÃ©clenchÃ© sur push et pull_request vers main et develop
on:
  push:
    branches: [main, develop]
    paths:
      - 'dashboard-client/src/**'
      - 'vitrine-client/src/**'
      - 'super-admin-client/src/**'
      - 'vitrine-quelyos/app/**'
      - 'packages/backend/src/**'
      - 'packages/config/**'
      - '.github/workflows/validate-config.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'dashboard-client/src/**'
      - 'vitrine-client/src/**'
      - 'super-admin-client/src/**'
      - 'vitrine-quelyos/app/**'
      - 'packages/backend/src/**'
      - 'packages/config/**'
      - '.github/workflows/validate-config.yml'

# Permissions minimales (principe du moindre privilÃ¨ge)
permissions:
  contents: read

jobs:
  check-hardcoded-urls:
    name: Check Hardcoded URLs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better analysis

      - name: Make script executable
        run: chmod +x ./scripts/check-hardcoded-urls.sh

      - name: Run URL validation script
        id: check_urls
        run: |
          echo "ğŸ” ExÃ©cution de la validation des URLs..."
          ./scripts/check-hardcoded-urls.sh
        continue-on-error: false

      - name: Report Success
        if: success()
        run: |
          echo "âœ… Aucune URL hardcodÃ©e dÃ©tectÃ©e"
          echo "âœ… ConformitÃ© @quelyos/config validÃ©e"
          echo ""
          echo "ğŸ“Š RÃ¨gles vÃ©rifiÃ©es:"
          echo "   â€¢ http://localhost:8069 (backend)"
          echo "   â€¢ http://localhost:3000 (vitrine)"
          echo "   â€¢ http://localhost:3001 (e-commerce)"
          echo "   â€¢ http://localhost:5175 (dashboard)"
          echo "   â€¢ http://localhost:9000 (super-admin)"

      - name: Report Failure
        if: failure()
        run: |
          echo "âŒ URLs hardcodÃ©es dÃ©tectÃ©es!"
          echo ""
          echo "ğŸ’¡ Solution:"
          echo "   1. Utiliser @quelyos/config au lieu des URLs hardcodÃ©es"
          echo "   2. Voir CLAUDE.md section 'ğŸ¯ URLS CENTRALISÃ‰ES'"
          echo ""
          echo "Exemple de correction:"
          echo "   âŒ const apiUrl = 'http://localhost:8069';"
          echo "   âœ… import { getBackendUrl } from '@quelyos/config';"
          echo "   âœ… const apiUrl = getBackendUrl(process.env.NODE_ENV as 'development' | 'production');"
          exit 1

  verify-config-package:
    name: Verify @quelyos/config Package
    runs-on: ubuntu-latest
    needs: check-hardcoded-urls

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build @quelyos/config
        run: pnpm --filter @quelyos/config build

      - name: Check package exports
        run: |
          echo "ğŸ” VÃ©rification des exports @quelyos/config..."

          # VÃ©rifier que le package est buildÃ©
          if [ ! -f "packages/config/dist/index.js" ]; then
            echo "âŒ Package @quelyos/config non buildÃ©!"
            exit 1
          fi

          echo "âœ… Package @quelyos/config buildÃ© avec succÃ¨s"

          # Afficher la taille du bundle
          SIZE=$(du -h packages/config/dist/index.js | cut -f1)
          echo "ğŸ“¦ Taille du bundle: $SIZE"

      - name: Run config tests
        run: |
          if [ -f "packages/config/package.json" ]; then
            cd packages/config
            if grep -q '"test"' package.json; then
              echo "ğŸ§ª ExÃ©cution des tests @quelyos/config..."
              pnpm test || echo "âš ï¸  Aucun test trouvÃ©"
            else
              echo "â­ï¸  Aucun test configurÃ©"
            fi
          fi

  validate-usage:
    name: Validate @quelyos/config Usage
    runs-on: ubuntu-latest
    needs: verify-config-package

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check config imports in frontends
        run: |
          echo "ğŸ” VÃ©rification des imports @quelyos/config..."

          # Compter les imports @quelyos/config
          IMPORT_COUNT=$(grep -r "from '@quelyos/config'" \
            dashboard-client/src \
            vitrine-client/src \
            super-admin-client/src \
            vitrine-quelyos/app \
            packages/backend/src \
            --include="*.ts" --include="*.tsx" 2>/dev/null | wc -l | tr -d ' ')

          echo "ğŸ“Š Nombre d'imports @quelyos/config: $IMPORT_COUNT"

          if [ "$IMPORT_COUNT" -lt 10 ]; then
            echo "âš ï¸  Peu d'imports dÃ©tectÃ©s ($IMPORT_COUNT). Migration incomplÃ¨te?"
          else
            echo "âœ… Migration @quelyos/config active ($IMPORT_COUNT imports)"
          fi

      - name: Check for direct URL usage (warnings)
        run: |
          echo "ğŸ” Recherche d'usages directs d'URLs (warnings non-bloquants)..."

          # Chercher des patterns suspects (non-bloquants)
          SUSPICIOUS=$(grep -rE "http://|https://" \
            dashboard-client/src \
            vitrine-client/src \
            super-admin-client/src \
            vitrine-quelyos/app \
            --include="*.ts" --include="*.tsx" \
            --exclude="*.test.ts" --exclude="*.spec.ts" 2>/dev/null | \
            grep -v "@quelyos/config" | \
            grep -v "// http" | \
            grep -v "* http" | \
            wc -l | tr -d ' ')

          if [ "$SUSPICIOUS" -gt 0 ]; then
            echo "âš ï¸  $SUSPICIOUS ligne(s) avec URLs dÃ©tectÃ©es (peut inclure des faux positifs)"
            echo "    VÃ©rifier manuellement si nÃ©cessaire"
          else
            echo "âœ… Aucun usage direct d'URL dÃ©tectÃ©"
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [check-hardcoded-urls, verify-config-package, validate-usage]
    if: always()

    steps:
      - name: Check overall status
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                           â•‘"
          echo "â•‘        VALIDATION CONFIGURATION - RÃ‰SUMÃ‰                  â•‘"
          echo "â•‘                                                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… VÃ©rifications effectuÃ©es:"
          echo "   â€¢ URLs hardcodÃ©es (bloquant)"
          echo "   â€¢ Package @quelyos/config (bloquant)"
          echo "   â€¢ Usage @quelyos/config (informatif)"
          echo ""
          echo "ğŸ“š Documentation:"
          echo "   â€¢ CLAUDE.md (section ğŸ¯ URLS CENTRALISÃ‰ES)"
          echo "   â€¢ .claude/MIGRATION_URLS_CENTRALISEES.md"
          echo "   â€¢ packages/config/README.md"
          echo ""
          echo "ğŸ”’ Protection active:"
          echo "   â€¢ Pre-commit hook (.husky/pre-commit)"
          echo "   â€¢ CI/CD validation (ce workflow)"
          echo "   â€¢ Script manuel (./scripts/check-hardcoded-urls.sh)"

      - name: Fail if any check failed
        if: |
          needs.check-hardcoded-urls.result == 'failure' ||
          needs.verify-config-package.result == 'failure' ||
          needs.validate-usage.result == 'failure'
        run: |
          echo "âŒ Une ou plusieurs vÃ©rifications ont Ã©chouÃ©"
          exit 1
