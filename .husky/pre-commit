# VÃ©rification anonymisation Odoo (P0 et P1 uniquement)
echo "ğŸ” VÃ©rification anonymisation /no-odoo..."

# P0 - UI visible (critique)
P0_COUNT=$(grep -rE "Odoo|odoo" vitrine-client/src dashboard-client/src vitrine-quelyos/app --include="*.tsx" --include="*.ts" 2>/dev/null | \
  grep -vE "legal/|api-anonymizer|\.test\.|lib/backend/|node_modules" | \
  grep -vE "^[^:]*:\s*(//|/\*|\*)" | \
  wc -l | tr -d ' ')

# P1 - Variables .env et mÃ©tadonnÃ©es
P1_ENV_COUNT=$(grep -rE "ODOO_|NEXT_PUBLIC_ODOO|VITE_ODOO" vitrine-client/.env.example dashboard-client/.env.example vitrine-quelyos/.env.example 2>/dev/null | wc -l | tr -d ' ')

if [ "$P0_COUNT" -gt 0 ] || [ "$P1_ENV_COUNT" -gt 0 ]; then
  echo "âŒ Violations anonymisation dÃ©tectÃ©es :"
  echo "   P0 (UI visible) : $P0_COUNT"
  echo "   P1 (variables .env) : $P1_ENV_COUNT"
  echo ""
  echo "   ExÃ©cutez '/no-odoo' pour voir les dÃ©tails"
  echo "   Corrigez les violations avant de commiter"
  exit 1
fi

echo "âœ… Anonymisation conforme (P0=0, P1=0)"

# VÃ©rification URLs hardcodÃ©es
echo ""
echo "ğŸ” VÃ©rification URLs hardcodÃ©es..."

# Patterns interdits
FORBIDDEN_PATTERNS=(
  "http://localhost:8069"
  "http://localhost:3000"
  "http://localhost:3001"
  "http://localhost:5175"
  "http://localhost:9000"
)

# RÃ©pertoires Ã  scanner
SCAN_DIRS=(
  "dashboard-client/src"
  "vitrine-client/src"
  "super-admin-client/src"
  "vitrine-quelyos/app"
  "packages/backend/src"
)

# Fichiers stagÃ©s seulement
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(ts|tsx|js|jsx)$")

if [ -n "$STAGED_FILES" ]; then
  violations=0

  for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
    # VÃ©rifier chaque fichier stagÃ©
    for file in $STAGED_FILES; do
      # VÃ©rifier si le fichier est dans un des rÃ©pertoires Ã  scanner
      for scan_dir in "${SCAN_DIRS[@]}"; do
        if [[ "$file" == "$scan_dir"* ]]; then
          # Chercher le pattern dans le fichier
          if grep -q "$pattern" "$file" 2>/dev/null; then
            if [ $violations -eq 0 ]; then
              echo ""
              echo "âŒ URLs hardcodÃ©es dÃ©tectÃ©es dans les fichiers stagÃ©s :"
              echo ""
            fi
            echo "   ğŸ“„ $file"
            echo "      Pattern : $pattern"
            grep -n "$pattern" "$file" | head -3 | sed 's/^/      /'
            echo ""
            violations=$((violations + 1))
          fi
          break
        fi
      done
    done
  done

  if [ $violations -gt 0 ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âŒ $violations violation(s) dÃ©tectÃ©e(s)"
    echo ""
    echo "ğŸ’¡ Solution : Utiliser @quelyos/config"
    echo ""
    echo "   Avant :"
    echo "   const apiUrl = 'http://localhost:8069';"
    echo ""
    echo "   AprÃ¨s :"
    echo "   import { getBackendUrl } from '@quelyos/config';"
    echo "   const apiUrl = getBackendUrl(process.env.NODE_ENV as 'development' | 'production');"
    echo ""
    echo "ğŸ“– Voir : CLAUDE.md section 'ğŸ¯ URLS CENTRALISÃ‰ES'"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
  fi

  echo "âœ… Aucune URL hardcodÃ©e dÃ©tectÃ©e"
else
  echo "â­ï¸  Aucun fichier .ts/.tsx stagÃ©"
fi

# Run lint-staged
echo ""
echo "ğŸ” Lancement lint-staged..."
pnpm exec lint-staged
