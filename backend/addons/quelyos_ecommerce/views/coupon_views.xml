<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Vue formulaire coupon -->
        <record id="view_ecommerce_coupon_form" model="ir.ui.view">
            <field name="name">ecommerce.coupon.form</field>
            <field name="model">ecommerce.coupon</field>
            <field name="arch" type="xml">
                <form string="Coupon de Réduction">
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                                <field name="active" widget="boolean_button" options="{'terminology': 'archive'}"/>
                            </button>
                        </div>

                        <group>
                            <group>
                                <field name="name" placeholder="Nom du coupon"/>
                                <field name="code" placeholder="CODE2024" style="text-transform:uppercase"/>
                                <field name="description" placeholder="Description du coupon"/>
                            </group>
                            <group>
                                <field name="discount_type"/>
                                <field name="discount_value"/>
                                <field name="maximum_discount" invisible="discount_type != 'percent'"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Conditions" name="conditions">
                                <group>
                                    <group string="Montants">
                                        <field name="minimum_amount"/>
                                    </group>
                                    <group string="Validité">
                                        <field name="date_start"/>
                                        <field name="date_end"/>
                                    </group>
                                </group>

                                <group string="Restrictions Produits">
                                    <field name="product_ids" widget="many2many_tags"/>
                                    <field name="category_ids" widget="many2many_tags"/>
                                </group>
                            </page>

                            <page string="Limitations Usage" name="usage">
                                <group>
                                    <group string="Limites Globales">
                                        <field name="usage_limit"/>
                                        <field name="usage_count" readonly="1"/>
                                    </group>
                                    <group string="Limites Client">
                                        <field name="usage_limit_per_customer"/>
                                        <field name="first_order_only"/>
                                    </group>
                                </group>

                                <group string="Clients Spécifiques">
                                    <field name="partner_ids" widget="many2many_tags"
                                           placeholder="Laisser vide pour tous les clients"/>
                                </group>
                            </page>

                            <page string="Statistiques" name="stats">
                                <group>
                                    <group>
                                        <field name="usage_count" readonly="1"/>
                                        <field name="total_discount_given" readonly="1" widget="monetary"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <!-- Vue liste coupon -->
        <record id="view_ecommerce_coupon_tree" model="ir.ui.view">
            <field name="name">ecommerce.coupon.list</field>
            <field name="model">ecommerce.coupon</field>
            <field name="arch" type="xml">
                <list string="Coupons" default_order="create_date desc">
                    <field name="code"/>
                    <field name="name"/>
                    <field name="discount_type"/>
                    <field name="discount_value"/>
                    <field name="minimum_amount" optional="hide"/>
                    <field name="date_start"/>
                    <field name="date_end"/>
                    <field name="usage_count"/>
                    <field name="usage_limit" optional="hide"/>
                    <field name="total_discount_given" widget="monetary" optional="show"/>
                    <field name="active" widget="boolean_toggle"/>
                </list>
            </field>
        </record>

        <!-- Vue recherche coupon -->
        <record id="view_ecommerce_coupon_search" model="ir.ui.view">
            <field name="name">ecommerce.coupon.search</field>
            <field name="model">ecommerce.coupon</field>
            <field name="arch" type="xml">
                <search string="Rechercher Coupons">
                    <field name="code" string="Code"/>
                    <field name="name" string="Nom"/>

                    <filter string="Actifs" name="active"
                            domain="[('active', '=', True)]"/>
                    <filter string="Archivés" name="archived"
                            domain="[('active', '=', False)]"/>

                    <separator/>

                    <filter string="En Cours" name="current"
                            domain="[('date_start', '&lt;=', context_today()), '|', ('date_end', '=', False), ('date_end', '&gt;=', context_today())]"/>
                    <filter string="À Venir" name="future"
                            domain="[('date_start', '&gt;', context_today())]"/>
                    <filter string="Expirés" name="expired"
                            domain="[('date_end', '&lt;', context_today())]"/>

                    <separator/>

                    <filter string="Pourcentage" name="percent"
                            domain="[('discount_type', '=', 'percent')]"/>
                    <filter string="Montant Fixe" name="fixed"
                            domain="[('discount_type', '=', 'fixed')]"/>
                    <filter string="Livraison Gratuite" name="free_shipping"
                            domain="[('discount_type', '=', 'free_shipping')]"/>

                    <separator/>

                    <filter string="Type" name="group_by_type"
                            context="{'group_by': 'discount_type'}"/>
                    <filter string="Date Début" name="group_by_start_date"
                            context="{'group_by': 'date_start:month'}"/>
                    <filter string="Date Fin" name="group_by_end_date"
                            context="{'group_by': 'date_end:month'}"/>
                </search>
            </field>
        </record>

        <!-- Vue kanban coupon -->
        <record id="view_ecommerce_coupon_kanban" model="ir.ui.view">
            <field name="name">ecommerce.coupon.kanban</field>
            <field name="model">ecommerce.coupon</field>
            <field name="arch" type="xml">
                <kanban>
                    <field name="id"/>
                    <field name="code"/>
                    <field name="name"/>
                    <field name="discount_type"/>
                    <field name="discount_value"/>
                    <field name="minimum_amount"/>
                    <field name="date_start"/>
                    <field name="date_end"/>
                    <field name="usage_count"/>
                    <field name="usage_limit"/>
                    <field name="active"/>
                    <templates>
                        <t t-name="card">
                            <div class="oe_kanban_global_click">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="code"/>
                                        </strong>
                                        <div class="o_kanban_record_subtitle">
                                            <field name="name"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_top_right">
                                        <t t-if="record.discount_type.raw_value == 'percent'">
                                            <span class="badge badge-primary">
                                                <field name="discount_value"/>%
                                            </span>
                                        </t>
                                        <t t-elif="record.discount_type.raw_value == 'fixed'">
                                            <span class="badge badge-success">
                                                -<field name="discount_value"/>€
                                            </span>
                                        </t>
                                        <t t-else="">
                                            <span class="badge badge-info">
                                                Livraison Gratuite
                                            </span>
                                        </t>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div>
                                        <i class="fa fa-calendar"/> <field name="date_start"/> → <field name="date_end"/>
                                    </div>
                                    <div t-if="record.minimum_amount.raw_value &gt; 0">
                                        <i class="fa fa-shopping-cart"/> Min: <field name="minimum_amount"/> €
                                    </div>
                                    <div class="mt-2">
                                        <i class="fa fa-line-chart"/> Usage: <field name="usage_count"/>
                                        <t t-if="record.usage_limit.raw_value &gt; 0">
                                            / <field name="usage_limit"/>
                                        </t>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="active" widget="boolean_button"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Action coupon -->
        <record id="action_ecommerce_coupon" model="ir.actions.act_window">
            <field name="name">Coupons</field>
            <field name="res_model">ecommerce.coupon</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="search_view_id" ref="view_ecommerce_coupon_search"/>
            <field name="context">{'search_default_active': 1, 'search_default_current': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Créez votre premier coupon de réduction
                </p>
                <p>
                    Les coupons permettent d'offrir des réductions à vos clients.
                    Configurez le type de réduction, les conditions d'application et les limites d'usage.
                </p>
            </field>
        </record>

        <!-- Extension vue sale.order pour afficher le coupon -->
        <record id="view_order_form_coupon" model="ir.ui.view">
            <field name="name">sale.order.form.coupon</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="quelyos_ecommerce.view_order_form_ecommerce"/>
            <field name="arch" type="xml">
                <xpath expr="//group[@name='customer_info']" position="after">
                    <group string="Coupon" name="coupon_info">
                        <field name="coupon_id"/>
                        <field name="coupon_discount" widget="monetary"/>
                    </group>
                </xpath>
            </field>
        </record>

        <!-- Menu coupons -->
<!--         <menuitem id="menu_ecommerce_coupons" (moved to menu.xml) -->
<!--                   name="Coupons" (moved to menu.xml) -->
<!--                   parent="menu_ecommerce_root" (moved to menu.xml) -->
<!--                   action="action_ecommerce_coupon" (moved to menu.xml) -->
<!--                   sequence="45"/> (moved to menu.xml) -->

    </data>
</odoo>
