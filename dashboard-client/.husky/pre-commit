#!/bin/sh
# Pre-commit hook - V√©rification UI/UX automatique

echo "üîç V√©rification UI/UX des fichiers modifi√©s..."

# R√©cup√©rer fichiers .tsx/.jsx modifi√©s
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx|jsx)$')

if [ -z "$CHANGED_FILES" ]; then
  echo "‚úÖ Aucun fichier React modifi√©"
  exit 0
fi

ERRORS=0
WARNINGS=0

for file in $CHANGED_FILES; do
  if [ ! -f "$file" ]; then
    continue
  fi

  echo "üìÑ Analyse: $file"

  # V√©rification 1 : bg-white sans dark:bg-
  if grep -q "className.*bg-white[^/-]" "$file"; then
    if ! grep -q "dark:bg-" "$file"; then
      echo "  ‚ùå ERREUR: bg-white sans variante dark:bg-gray-800"
      ERRORS=$((ERRORS + 1))
    fi
  fi

  # V√©rification 2 : text-gray-900 sans dark:text-white
  if grep -q "className.*text-gray-900" "$file"; then
    LINE_CONTEXT=$(grep -n "text-gray-900" "$file" | head -1)
    if ! echo "$LINE_CONTEXT" | grep -q "dark:text-white"; then
      echo "  ‚ùå ERREUR: text-gray-900 sans dark:text-white"
      ERRORS=$((ERRORS + 1))
    fi
  fi

  # V√©rification 3 : border-gray-200 sans dark:border-gray-700
  if grep -q "border-gray-200" "$file"; then
    if ! grep -q "dark:border-gray-700" "$file"; then
      echo "  ‚ö†Ô∏è  WARNING: border-gray-200 sans dark:border-gray-700"
      WARNINGS=$((WARNINGS + 1))
    fi
  fi

  # V√©rification 4 : Labels avec text-gray-700 (incorrect)
  if grep -q "<label" "$file"; then
    # Chercher text-gray-700 qui n'est PAS un hover/focus state
    LABEL_LINES=$(grep -A 3 "<label" "$file" | grep "text-gray-700" | grep -v "hover:" | grep -v "focus:")
    if [ -n "$LABEL_LINES" ]; then
      echo "  ‚ùå ERREUR: Label avec text-gray-700 (utiliser text-gray-900 dark:text-white)"
      ERRORS=$((ERRORS + 1))
    fi
  fi

  # V√©rification 5 : Inputs sans variantes dark
  if grep -qE "<input|<select|<textarea" "$file"; then
    if grep -q "bg-white" "$file" && ! grep -qE "dark:bg-gray|dark:bg-white/10" "$file"; then
      echo "  ‚ö†Ô∏è  WARNING: Input/Select sans dark:bg-"
      WARNINGS=$((WARNINGS + 1))
    fi
  fi

  # V√©rification 6 : GlassPanel sans padding
  if grep -qE "GlassPanel|GlassCard" "$file"; then
    CONTEXT=$(grep -A 2 -E "GlassPanel|GlassCard" "$file")
    if ! echo "$CONTEXT" | grep -q "className.*p-[0-9]"; then
      echo "  ‚ö†Ô∏è  WARNING: GlassPanel/GlassCard sans padding"
      WARNINGS=$((WARNINGS + 1))
    fi
  fi

  # V√©rification 7 : text-white isol√© (potentiellement invisible en light)
  if grep -q 'className="[^"]*text-white[^"]*"' "$file"; then
    if ! grep -qE "text-gray-.*dark:text-white|dark:text-white.*text-gray" "$file"; then
      echo "  ‚ö†Ô∏è  WARNING: text-white sans contrepartie light mode"
      WARNINGS=$((WARNINGS + 1))
    fi
  fi
done

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
  echo "‚úÖ Toutes les v√©rifications UI/UX sont pass√©es"
  exit 0
elif [ $ERRORS -eq 0 ]; then
  echo "‚ö†Ô∏è  $WARNINGS warning(s) d√©tect√©(s) - Commit autoris√©"
  echo ""
  echo "üí° Conseil: Corrigez les warnings pour am√©liorer l'accessibilit√©"
  exit 0
else
  echo "‚ùå $ERRORS erreur(s) critique(s) d√©tect√©e(s)"
  if [ $WARNINGS -gt 0 ]; then
    echo "‚ö†Ô∏è  $WARNINGS warning(s) suppl√©mentaire(s)"
  fi
  echo ""
  echo "üîß Corrections requises avant le commit:"
  echo "   - Ajouter variantes dark: pour tous les backgrounds"
  echo "   - Corriger les labels avec text-gray-900 dark:text-white"
  echo "   - V√©rifier que tous les textes sont lisibles en light ET dark"
  echo ""
  echo "üí° Astuce: Lancer /uiux pour audit complet"
  exit 1
fi
