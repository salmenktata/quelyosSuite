# ========================================
# Configuration Sécurité API Quelyos
# ========================================
# 
# Fonctionnalités :
# - CORS restrictif (liste blanche domaines)
# - Rate limiting (protection DoS)
# - Headers sécurité (CSP, X-Frame-Options, etc.)
#
# Déploiement :
# 1. Copier ce fichier dans /etc/nginx/conf.d/
# 2. Recharger nginx : sudo nginx -s reload
# 3. Tester : curl -I https://api.quelyos.com/api/health
#

# ========================================
# RATE LIMITING
# ========================================

# Zone mémoire 10MB pour stocker états rate limit
# 100 requêtes/minute par IP
limit_req_zone $binary_remote_addr zone=api_general:10m rate=100r/m;

# Zone spécifique endpoints sensibles (auth, admin)
# 20 requêtes/minute par IP
limit_req_zone $binary_remote_addr zone=api_auth:10m rate=20r/m;

# Zone endpoints publics (catalogue produits)
# 200 requêtes/minute par IP
limit_req_zone $binary_remote_addr zone=api_public:10m rate=200r/m;

# ========================================
# LISTE BLANCHE CORS
# ========================================

# Origines autorisées (à adapter selon environnement)
map $http_origin $cors_origin {
    default "";
    
    # Développement local
    "http://localhost:3000" $http_origin;      # Vitrine Quelyos
    "http://localhost:3001" $http_origin;      # E-commerce
    "http://localhost:5175" $http_origin;      # Dashboard (ERP)
    "http://localhost:9000" $http_origin;      # Super Admin
    
    # 7 SaaS Locaux
    "http://localhost:3010" $http_origin;      # Finance OS
    "http://localhost:3011" $http_origin;      # Store OS
    "http://localhost:3012" $http_origin;      # Copilote Ops
    "http://localhost:3013" $http_origin;      # Sales OS
    "http://localhost:3014" $http_origin;      # Retail OS
    "http://localhost:3015" $http_origin;      # Team OS
    "http://localhost:3016" $http_origin;      # Support OS
    
    # Production (décommenter selon besoin)
    # "https://quelyos.com" $http_origin;
    # "https://www.quelyos.com" $http_origin;
    # "https://app.quelyos.com" $http_origin;
    # "https://admin.quelyos.com" $http_origin;
    # "https://finance.quelyos.com" $http_origin;
    # "https://store.quelyos.com" $http_origin;
    # "https://copilote.quelyos.com" $http_origin;
    # "https://sales.quelyos.com" $http_origin;
    # "https://retail.quelyos.com" $http_origin;
    # "https://team.quelyos.com" $http_origin;
    # "https://support.quelyos.com" $http_origin;
}

# ========================================
# CONFIGURATION SERVEUR
# ========================================

server {
    listen 80;
    server_name api.quelyos.local localhost;
    
    # Redirection HTTPS (production uniquement)
    # return 301 https://$server_name$request_uri;
    
    # ========================================
    # HEADERS SÉCURITÉ GLOBAUX
    # ========================================
    
    # Protection clickjacking
    add_header X-Frame-Options "DENY" always;
    
    # Protection MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Protection XSS navigateur
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Content Security Policy (à adapter selon besoin)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
    
    # Référer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # HSTS (HTTPS uniquement, décommenter en production)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # ========================================
    # ENDPOINTS API FINANCE
    # ========================================
    
    # Endpoints Finance généraux (factures, paiements, etc.)
    location ~ ^/api/finance/(invoices|bills|payments|chart-of-accounts|fiscal-years|journals) {
        # Rate limiting modéré (100 req/min)
        limit_req zone=api_general burst=20 nodelay;
        
        # CORS restrictif
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Tenant-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Max-Age "3600" always;
        
        # OPTIONS preflight
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        # Proxy vers Odoo
        proxy_pass http://localhost:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Endpoints Finance sensibles (consolidation, budgets, etc.)
    location ~ ^/api/finance/(consolidation|budgets|cost-centers|cfo) {
        # Rate limiting strict (20 req/min)
        limit_req zone=api_auth burst=5 nodelay;
        
        # CORS restrictif
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Tenant-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        proxy_pass http://localhost:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Endpoints Finance ML/Premium (forecasting, open-banking, sepa)
    location ~ ^/api/finance/(forecasting|open-banking|sepa) {
        # Rate limiting modéré
        limit_req zone=api_general burst=10 nodelay;
        
        # CORS restrictif
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Tenant-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        proxy_pass http://localhost:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # Endpoints Finance rapports (OCA, reports)
    location ~ ^/api/finance/(reports|tax-reports) {
        # Rate limiting large (200 req/min - lecture seule)
        limit_req zone=api_public burst=50 nodelay;
        
        # CORS restrictif
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Tenant-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        proxy_pass http://localhost:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # ========================================
    # ENDPOINTS API AUTRES MODULES
    # ========================================
    
    # Catch-all pour autres endpoints API
    location /api/ {
        # Rate limiting modéré par défaut
        limit_req zone=api_general burst=20 nodelay;
        
        # CORS restrictif
        add_header Access-Control-Allow-Origin $cors_origin always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Tenant-ID" always;
        add_header Access-Control-Allow-Credentials "true" always;
        
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        proxy_pass http://localhost:8069;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # ========================================
    # MONITORING & HEALTH
    # ========================================
    
    # Health check (pas de rate limiting)
    location /api/health {
        proxy_pass http://localhost:8069;
        access_log off;
    }
    
    # Logs access pour monitoring
    access_log /var/log/nginx/quelyos-api-access.log;
    error_log /var/log/nginx/quelyos-api-error.log warn;
}
